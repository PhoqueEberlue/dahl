#include "starpu_data_interfaces.h"
#include "tests.h"

#include "../include/dahl_convolution.h"
#include "../src/utils.h"
#include <stdio.h>

// First image of the fashion mnist dataset
static constexpr dahl_fp sample[28][28] = {
    { 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000 },
    { 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000 },
    { 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000 },
    { 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.003922, 0.000000, 0.000000, 0.050980, 0.286275, 0.000000, 0.000000, 0.003922, 0.015686, 0.000000, 0.000000, 0.000000, 0.000000, 0.003922, 0.003922, 0.000000 },
    { 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.011765, 0.000000, 0.141176, 0.533333, 0.498039, 0.243137, 0.211765, 0.000000, 0.000000, 0.000000, 0.003922, 0.011765, 0.015686, 0.000000, 0.000000, 0.011765 },
    { 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.023529, 0.000000, 0.400000, 0.800000, 0.690196, 0.525490, 0.564706, 0.482353, 0.090196, 0.000000, 0.000000, 0.000000, 0.000000, 0.047059, 0.039216, 0.000000 },
    { 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.607843, 0.925490, 0.811765, 0.698039, 0.419608, 0.611765, 0.631373, 0.427451, 0.250980, 0.090196, 0.301961, 0.509804, 0.282353, 0.058824 },
    { 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.003922, 0.000000, 0.270588, 0.811765, 0.874510, 0.854902, 0.847059, 0.847059, 0.639216, 0.498039, 0.474510, 0.478431, 0.572549, 0.552941, 0.345098, 0.674510, 0.258824 },
    { 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.003922, 0.003922, 0.003922, 0.000000, 0.784314, 0.909804, 0.909804, 0.913725, 0.898039, 0.874510, 0.874510, 0.843137, 0.835294, 0.643137, 0.498039, 0.482353, 0.768627, 0.898039, 0.000000 },
    { 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.717647, 0.882353, 0.847059, 0.874510, 0.894118, 0.921569, 0.890196, 0.878431, 0.870588, 0.878431, 0.866667, 0.874510, 0.960784, 0.678431, 0.000000 },
    { 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.756863, 0.894118, 0.854902, 0.835294, 0.776471, 0.705882, 0.831373, 0.823529, 0.827451, 0.835294, 0.874510, 0.862745, 0.952941, 0.792157, 0.000000 },
    { 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.003922, 0.011765, 0.000000, 0.047059, 0.858824, 0.862745, 0.831373, 0.854902, 0.752941, 0.662745, 0.890196, 0.815686, 0.854902, 0.878431, 0.831373, 0.886275, 0.772549, 0.819608, 0.203922 },
    { 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.023529, 0.000000, 0.388235, 0.956863, 0.870588, 0.862745, 0.854902, 0.796078, 0.776471, 0.866667, 0.843137, 0.835294, 0.870588, 0.862745, 0.960784, 0.466667, 0.654902, 0.219608 },
    { 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.015686, 0.000000, 0.000000, 0.215686, 0.925490, 0.894118, 0.901961, 0.894118, 0.941176, 0.909804, 0.835294, 0.854902, 0.874510, 0.917647, 0.850980, 0.850980, 0.819608, 0.360784, 0.000000 },
    { 0.000000, 0.000000, 0.003922, 0.015686, 0.023529, 0.027451, 0.007843, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.929412, 0.886275, 0.850980, 0.874510, 0.870588, 0.858824, 0.870588, 0.866667, 0.847059, 0.874510, 0.898039, 0.843137, 0.854902, 1.000000, 0.301961, 0.000000 },
    { 0.000000, 0.011765, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.243137, 0.568627, 0.800000, 0.894118, 0.811765, 0.835294, 0.866667, 0.854902, 0.815686, 0.827451, 0.854902, 0.878431, 0.874510, 0.858824, 0.843137, 0.878431, 0.956863, 0.623529, 0.000000 },
    { 0.000000, 0.000000, 0.000000, 0.000000, 0.070588, 0.172549, 0.321569, 0.419608, 0.741176, 0.894118, 0.862745, 0.870588, 0.850980, 0.886275, 0.784314, 0.803922, 0.827451, 0.901961, 0.878431, 0.917647, 0.690196, 0.737255, 0.980392, 0.972549, 0.913725, 0.933333, 0.843137, 0.000000 },
    { 0.000000, 0.223529, 0.733333, 0.815686, 0.878431, 0.866667, 0.878431, 0.815686, 0.800000, 0.839216, 0.815686, 0.819608, 0.784314, 0.623529, 0.960784, 0.756863, 0.807843, 0.874510, 1.000000, 1.000000, 0.866667, 0.917647, 0.866667, 0.827451, 0.862745, 0.909804, 0.964706, 0.000000 },
    { 0.011765, 0.792157, 0.894118, 0.878431, 0.866667, 0.827451, 0.827451, 0.839216, 0.803922, 0.803922, 0.803922, 0.862745, 0.941176, 0.313725, 0.588235, 1.000000, 0.898039, 0.866667, 0.737255, 0.603922, 0.749020, 0.823529, 0.800000, 0.819608, 0.870588, 0.894118, 0.882353, 0.000000 },
    { 0.384314, 0.913725, 0.776471, 0.823529, 0.870588, 0.898039, 0.898039, 0.917647, 0.976471, 0.862745, 0.760784, 0.843137, 0.850980, 0.945098, 0.254902, 0.286275, 0.415686, 0.458824, 0.658824, 0.858824, 0.866667, 0.843137, 0.850980, 0.874510, 0.874510, 0.878431, 0.898039, 0.113725 },
    { 0.294118, 0.800000, 0.831373, 0.800000, 0.756863, 0.803922, 0.827451, 0.882353, 0.847059, 0.725490, 0.772549, 0.807843, 0.776471, 0.835294, 0.941176, 0.764706, 0.890196, 0.960784, 0.937255, 0.874510, 0.854902, 0.831373, 0.819608, 0.870588, 0.862745, 0.866667, 0.901961, 0.262745 },
    { 0.188235, 0.796078, 0.717647, 0.760784, 0.835294, 0.772549, 0.725490, 0.745098, 0.760784, 0.752941, 0.792157, 0.839216, 0.858824, 0.866667, 0.862745, 0.925490, 0.882353, 0.847059, 0.780392, 0.807843, 0.729412, 0.709804, 0.694118, 0.674510, 0.709804, 0.803922, 0.807843, 0.450980 },
    { 0.000000, 0.478431, 0.858824, 0.756863, 0.701961, 0.670588, 0.717647, 0.768627, 0.800000, 0.823529, 0.835294, 0.811765, 0.827451, 0.823529, 0.784314, 0.768627, 0.760784, 0.749020, 0.764706, 0.749020, 0.776471, 0.752941, 0.690196, 0.611765, 0.654902, 0.694118, 0.823529, 0.360784 },
    { 0.000000, 0.000000, 0.290196, 0.741176, 0.831373, 0.749020, 0.686275, 0.674510, 0.686275, 0.709804, 0.725490, 0.737255, 0.741176, 0.737255, 0.756863, 0.776471, 0.800000, 0.819608, 0.823529, 0.823529, 0.827451, 0.737255, 0.737255, 0.760784, 0.752941, 0.847059, 0.666667, 0.000000 },
    { 0.007843, 0.000000, 0.000000, 0.000000, 0.258824, 0.784314, 0.870588, 0.929412, 0.937255, 0.949020, 0.964706, 0.952941, 0.956863, 0.866667, 0.862745, 0.756863, 0.749020, 0.701961, 0.713725, 0.713725, 0.709804, 0.690196, 0.650980, 0.658824, 0.388235, 0.227451, 0.000000, 0.000000 },
    { 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.156863, 0.239216, 0.172549, 0.282353, 0.160784, 0.137255, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000 },
    { 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000 },
    { 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000 },
};

static constexpr dahl_fp expect_conv_out[2][23][23] = {
    {
        { 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.959941, 1.495267, 0.757015, 0.000000, 0.000000, 0.000000 },
        { 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.035574, 0.019103, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000 },
        { 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.043676, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000 },
        { 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000 },
        { 0.000000, 0.000000, 0.000000, 0.000000, 0.001804, 0.004459, 0.007856, 0.004095, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000 },
        { 0.000000, 0.000000, 0.000000, 0.000000, 0.008879, 0.014986, 0.016735, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000 },
        { 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000 },
        { 0.000000, 0.000000, 0.000000, 0.000000, 0.009941, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000 },
        { 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.012579, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000 },
        { 0.000000, 0.000000, 0.000000, 0.086599, 0.108520, 0.091797, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000 },
        { 0.026019, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000 },
        { 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000 },
        { 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000 },
        { 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000 },
        { 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.537136, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000 },
        { 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000 },
        { 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000 },
        { 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000 },
        { 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000 },
        { 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000 },
        { 3.967658, 6.058680, 3.762320, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000 },
        { 0.000000, 1.539352, 5.388913, 7.931839, 7.691914, 4.725359, 3.317029, 2.458702, 2.296104, 2.324836, 2.194856, 2.837097, 3.416413, 4.089049, 4.047153, 4.433351, 4.698495, 4.611545, 4.261716, 3.155624, 2.452042, 1.651297, 2.812774 },
        { 0.000000, 0.000000, 0.000000, 0.000000, 0.928678, 3.197815, 3.904344, 3.386917, 2.501609, 3.112966, 2.085502, 2.409598, 1.650234, 1.559420, 0.950774, 0.507054, 0.179422, 0.436427, 0.924367, 0.763289, 1.756861, 0.855936, 0.098635 },
    },
    {
        { 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.103589, 0.046844, 1.400620, 4.319157, 4.685526, 1.105815, 0.689955, 0.812284, 0.000000, 0.000000, 0.000000, 0.000000, 0.217577, 0.306586, 0.152178, 0.000000 },
        { 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.059866, 0.040879, 2.868361, 6.866052, 3.805700, 0.621559, 0.000000, 0.254759, 3.127448, 0.000000, 0.447252, 0.000000, 0.000000, 1.272566, 0.628354, 0.000000 },
        { 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.012369, 0.032549, 0.771629, 4.425605, 5.744335, 1.831542, 0.000000, 0.000000, 0.000000, 1.705498, 1.562393, 1.001166, 3.158495, 2.779493, 1.064415, 1.838171, 0.000000 },
        { 0.000000, 0.000000, 0.000000, 0.000000, 0.012369, 0.015824, 0.012030, 0.000000, 2.842992, 6.098719, 2.921777, 0.000000, 0.000000, 0.000000, 0.000000, 2.897229, 2.286666, 1.833092, 0.611566, 2.456074, 4.306570, 3.129652, 0.000000 },
        { 0.000000, 0.000000, 0.000000, 0.000000, 0.006312, 0.018113, 0.022985, 0.000000, 4.158523, 6.990230, 0.520984, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 1.473512, 5.173591, 3.283690, 0.548537, 1.376384, 0.000000 },
        { 0.000000, 0.000000, 0.000000, 0.000000, 0.010452, 0.001166, 0.000000, 0.020045, 4.920038, 5.630710, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.802773, 3.905437, 0.935924, 0.000000 },
        { 0.000000, 0.000000, 0.000000, 0.000000, 0.003016, 0.029145, 0.000000, 0.097774, 3.624077, 4.635357, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000 },
        { 0.000000, 0.000000, 0.000000, 0.000000, 0.000757, 0.089653, 0.030661, 1.177910, 4.713706, 2.629241, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000 },
        { 0.000000, 0.000000, 0.000000, 0.000000, 0.068624, 0.074954, 0.001860, 1.376782, 6.849000, 1.975359, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000 },
        { 0.072938, 0.005214, 0.000000, 0.000000, 0.000000, 0.082664, 0.000000, 4.114021, 5.787808, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000 },
        { 0.070336, 0.076959, 0.005655, 0.000000, 0.782653, 1.806144, 2.270983, 3.400641, 5.657340, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000 },
        { 0.599596, 0.794375, 1.140245, 1.994369, 3.059631, 3.492088, 4.369154, 5.919582, 2.119921, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000 },
        { 2.516766, 2.206946, 2.765799, 3.330696, 5.422737, 5.502037, 3.913447, 0.991927, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000 },
        { 4.532721, 4.983516, 2.991200, 2.588805, 1.346239, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000 },
        { 1.553266, 0.000000, 0.292253, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000 },
        { 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000 },
        { 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000 },
        { 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000 },
        { 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000 },
        { 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000 },
        { 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000 },
        { 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000 },
        { 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000 },
    }
};

void test_convolution()
{
    dahl_shape2d constexpr input_shape = { .x = 28, .y = 28 };
    size_t const num_channels = 2;
    dahl_convolution* conv = convolution_init(input_shape, 6, num_channels);

    dahl_matrix const* img_matrix = matrix_init_from(input_shape, (dahl_fp*)&sample);

    dahl_block* conv_out = convolution_forward(conv, img_matrix);

    dahl_shape3d constexpr expect_shape = { .x = 23, .y = 23, .z = 2 };
    dahl_block const* expect_block = block_init_from(expect_shape, (dahl_fp*)&expect_conv_out);

    ASSERT_BLOCK_EQUALS_ROUND(expect_block, conv_out, 6);
}
